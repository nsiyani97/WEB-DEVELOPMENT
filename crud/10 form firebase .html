<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <h1>Firebase CRUD</h1>
    <hr />
    <form>
      <label for="name"></label>
      <input type="text" name="name" id="name" placeholder="Name" />
      <label for="tel"></label>
      <input type="tel" name="tel" id="tel" placeholder="Tel" />
      <label for="email"></label>
      <input type="email" name="email" id="email" placeholder="Email" />
      <button type="submit">Submit</button>
    </form>
    <table border="1" cellpadding="5">
      <thead>
        <tr>
          <th>Id</th>
          <th>Name</th>
          <th>Tel</th>
          <th>Email</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-analytics.js";
      import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
      // TODO: Add SDKs for Firebase products that you want to use
      // https://firebase.google.com/docs/web/setup#available-libraries

      // Your web app's Firebase configuration
      // For Firebase JS SDK v7.20.0 and later, measurementId is optional
      const firebaseConfig = {
        apiKey: "AIzaSyB4GW8B0OA9wzX4UAiBeLDa3w0eWGNFez8",
        authDomain: "my-first-project-bec63.firebaseapp.com",
        projectId: "my-first-project-bec63",
        storageBucket: "my-first-project-bec63.firebasestorage.app",
        messagingSenderId: "701356026896",
        appId: "1:701356026896:web:40ff4d86e2042525b4ee95",
        measurementId: "G-2QQL1EC1GZ",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      const db = getFirestore(app);
      let editId = null;

      async function getUsers() {
        const userData = await getDocs(collection(db, "users"));
        displayUsers(userData);
      }

      function displayUsers(userData) {
        let tbody = document.getElementById("tbody");
        tbody.innerHTML = "";
        userData.forEach((doc) => {
          const i = doc.data(); // Firestore wraps your data inside a snapshot — .data() unwraps it.
          const id = doc.id; // to access id — .id
          tbody.innerHTML += `
          <tr>
            <td>${id}</td>
            <td>${i.name}</td>
            <td>${i.tel}</td>
            <td>${i.email}</td>
            <td>
              <button onclick="editUser('${id}')">Edit</button>
              <button onclick="deleteUser('${id}')">Delete</button>
            </td>
          </tr>
          `;
        });
      }

      const form = document.querySelector("form");

      form.addEventListener("submit", (event) => {
        event.preventDefault();
        let name = document.getElementById("name").value;
        let tel = document.getElementById("tel").value;
        let email = document.getElementById("email").value;

        if (editId != null) {
          updateDoc(doc(db, "users", editId), {
            name: name,
            tel: tel,
            email: email,
          });
          editId = null;
          getUsers();
        } else {
          addDoc(collection(db, "users"), {
            name: name,
            tel: tel,
            email: email,
          });
          getUsers();
        }

        document.getElementById("name").value = "";
        document.getElementById("tel").value = "";
        document.getElementById("email").value = "";
      });

      // function newUser(event) {
      //   event.preventDefault();
      //   let name = document.getElementById("name").value;
      //   let tel = document.getElementById("tel").value;
      //   let email = document.getElementById("email").value;
      //   addDoc(collection(db, "users"), {
      //     name: name,
      //     tel: tel,
      //     email: email,
      //   });
      // }

      window.editUser = async function (id) {
        const docRef = doc(db, "users", id); // creates a reference of user
        const docSnap = await getDoc(docRef); // fetch the document of user
        const data = docSnap.data();

        document.getElementById("name").value = data.name;
        document.getElementById("tel").value = data.tel;
        document.getElementById("email").value = data.email;

        editId = id;
      };

      window.deleteUser = async function (id) {
        await deleteDoc(doc(db, "users", id));
        getUsers();
      };

      window.onload = getUsers;
    </script>
  </body>
</html>
